# ğŸ—ï¸ System Architecture - After Fixes

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React/Next.js)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  TopNavbar   â”‚  â”‚  SidebarNav  â”‚  â”‚  Pages       â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ â€¢ Notif      â”‚  â”‚ â€¢ Workspaces â”‚  â”‚ â€¢ Dashboard  â”‚          â”‚
â”‚  â”‚   Badge âœ…   â”‚  â”‚   Count âœ…   â”‚  â”‚ â€¢ Notes      â”‚          â”‚
â”‚  â”‚ â€¢ User Menu  â”‚  â”‚ â€¢ Notes      â”‚  â”‚ â€¢ Documents  â”‚          â”‚
â”‚  â”‚              â”‚  â”‚   Count âœ…   â”‚  â”‚ â€¢ Members    â”‚          â”‚
â”‚  â”‚ Auto-refresh â”‚  â”‚ â€¢ Docs       â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ every 30s    â”‚  â”‚   Count âœ…   â”‚  â”‚              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                 â”‚                 â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                           â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                    â”‚ AuthContext â”‚                              â”‚
â”‚                    â”‚             â”‚                              â”‚
â”‚                    â”‚ â€¢ Token     â”‚                              â”‚
â”‚                    â”‚ â€¢ User      â”‚                              â”‚
â”‚                    â”‚ â€¢ Login     â”‚                              â”‚
â”‚                    â”‚ â€¢ Logout    â”‚                              â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                           â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP Requests (JWT Token)
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API ROUTES (Next.js)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/auth       â”‚  â”‚ /api/stats âœ…   â”‚  â”‚ /api/dashboard  â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ POST /signup  â”‚  â”‚ â€¢ GET /         â”‚  â”‚ â€¢ GET /summary  â”‚ â”‚
â”‚  â”‚ â€¢ POST /login   â”‚  â”‚   Returns:      â”‚  â”‚   Returns:      â”‚ â”‚
â”‚  â”‚ â€¢ GET  /me      â”‚  â”‚   - workspaces  â”‚  â”‚   - Real counts â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚   - notes       â”‚  â”‚   - Activity    â”‚ â”‚
â”‚  â”‚ Status codes:   â”‚  â”‚   - documents   â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ 200 Success   â”‚  â”‚   - notifs      â”‚  â”‚ Fixed: Real DB  â”‚ â”‚
â”‚  â”‚ â€¢ 401 Invalid   â”‚  â”‚                 â”‚  â”‚ queries âœ…      â”‚ â”‚
â”‚  â”‚ â€¢ 409 Duplicate â”‚  â”‚ NEW endpoint!   â”‚  â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/notes      â”‚  â”‚ /api/documents  â”‚  â”‚ /api/members    â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ GET  /        â”‚  â”‚ â€¢ GET  /        â”‚  â”‚ â€¢ GET  /        â”‚ â”‚
â”‚  â”‚ â€¢ POST /        â”‚  â”‚ â€¢ POST /        â”‚  â”‚ â€¢ POST /        â”‚ â”‚
â”‚  â”‚ â€¢ GET  /[id] âœ… â”‚  â”‚ â€¢ GET  /[id] âœ… â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ PATCH/[id]    â”‚  â”‚ â€¢ PATCH/[id]    â”‚  â”‚ Query params:   â”‚ â”‚
â”‚  â”‚ â€¢ DELETE/[id]   â”‚  â”‚ â€¢ DELETE/[id]   â”‚  â”‚ ?workspaceId=   â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ Fixed:          â”‚  â”‚ Fixed:          â”‚  â”‚ Working âœ…      â”‚ â”‚
â”‚  â”‚ â€¢ ObjectId      â”‚  â”‚ â€¢ ObjectId      â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚   validation âœ… â”‚  â”‚   validation âœ… â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ 400/404/403   â”‚  â”‚ â€¢ 400/404/403   â”‚  â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/notifications âœ…                                        â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ â€¢ GET / - Returns REAL notifications from MongoDB           â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ Fixed: Removed hardcoded data, queries Notification model   â”‚ â”‚
â”‚  â”‚ Returns: { data: [...], unreadCount: N }                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚                           â”‚                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚  Middleware â”‚                               â”‚
â”‚                    â”‚             â”‚                               â”‚
â”‚                    â”‚ â€¢ JWT       â”‚                               â”‚
â”‚                    â”‚   Verify    â”‚                               â”‚
â”‚                    â”‚ â€¢ Error     â”‚                               â”‚
â”‚                    â”‚   Handler   â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                           â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ MongoDB Queries
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVICES & UTILITIES                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ mongodb.ts   â”‚  â”‚ logger.ts âœ… â”‚  â”‚ env-validatorâ”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ .ts âœ…       â”‚           â”‚
â”‚  â”‚ â€¢ connectDB  â”‚  â”‚ â€¢ info()     â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ â€¢ Connection â”‚  â”‚ â€¢ success()  â”‚  â”‚ â€¢ Validates  â”‚           â”‚
â”‚  â”‚   pooling    â”‚  â”‚ â€¢ error()    â”‚  â”‚   MONGODB_   â”‚           â”‚
â”‚  â”‚ â€¢ Auto       â”‚  â”‚ â€¢ warning()  â”‚  â”‚   URI        â”‚           â”‚
â”‚  â”‚   reconnect  â”‚  â”‚ â€¢ debug()    â”‚  â”‚ â€¢ Validates  â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚   JWT_SECRET â”‚           â”‚
â”‚  â”‚ Status:      â”‚  â”‚ NEW utility! â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ Working âœ…   â”‚  â”‚              â”‚  â”‚ NEW utility! â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ file-upload  â”‚  â”‚ document-    â”‚  â”‚ search-      â”‚           â”‚
â”‚  â”‚ .ts          â”‚  â”‚ processor.ts â”‚  â”‚ service.ts   â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ â€¢ uploadFile â”‚  â”‚ â€¢ extractTextâ”‚  â”‚ â€¢ index      â”‚           â”‚
â”‚  â”‚ â€¢ deleteFile â”‚  â”‚ â€¢ PDF parse  â”‚  â”‚ â€¢ search     â”‚           â”‚
â”‚  â”‚ â€¢ Auto-      â”‚  â”‚ â€¢ DOCX parse â”‚  â”‚ â€¢ delete     â”‚           â”‚
â”‚  â”‚   create     â”‚  â”‚ â€¢ TXT parse  â”‚  â”‚              â”‚           â”‚
â”‚  â”‚   uploads/   â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚   folder âœ…  â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Mongoose ODM
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MONGODB DATABASE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ users        â”‚  â”‚ workspaces   â”‚  â”‚ notes        â”‚            â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ â€¢ _id        â”‚  â”‚ â€¢ _id        â”‚  â”‚ â€¢ _id        â”‚            â”‚
â”‚  â”‚ â€¢ name       â”‚  â”‚ â€¢ name       â”‚  â”‚ â€¢ title      â”‚            â”‚
â”‚  â”‚ â€¢ email      â”‚  â”‚ â€¢ owner      â”‚  â”‚ â€¢ content    â”‚            â”‚
â”‚  â”‚ â€¢ password   â”‚  â”‚ â€¢ members[]  â”‚  â”‚ â€¢ author     â”‚            â”‚
â”‚  â”‚ â€¢ role       â”‚  â”‚ â€¢ createdAt  â”‚  â”‚ â€¢ workspace  â”‚            â”‚
â”‚  â”‚ â€¢ createdAt  â”‚  â”‚              â”‚  â”‚ â€¢ tags[]     â”‚            â”‚
â”‚  â”‚              â”‚  â”‚ Count: Real  â”‚  â”‚ â€¢ isPinned   â”‚            â”‚
â”‚  â”‚              â”‚  â”‚ via API âœ…   â”‚  â”‚              â”‚            â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ Count: Real  â”‚            â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ via API âœ…   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ documents    â”‚  â”‚ notificationsâ”‚  â”‚ members      â”‚            â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ â€¢ _id        â”‚  â”‚ â€¢ _id        â”‚  â”‚ (embedded in â”‚            â”‚
â”‚  â”‚ â€¢ title      â”‚  â”‚ â€¢ user       â”‚  â”‚  workspaces) â”‚            â”‚
â”‚  â”‚ â€¢ fileName   â”‚  â”‚ â€¢ type       â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ â€¢ fileUrl    â”‚  â”‚ â€¢ title      â”‚  â”‚ â€¢ user       â”‚            â”‚
â”‚  â”‚ â€¢ fileSize   â”‚  â”‚ â€¢ message    â”‚  â”‚ â€¢ role       â”‚            â”‚
â”‚  â”‚ â€¢ author     â”‚  â”‚ â€¢ read       â”‚  â”‚ â€¢ joinedAt   â”‚            â”‚
â”‚  â”‚ â€¢ workspace  â”‚  â”‚ â€¢ createdAt  â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ â€¢ extracted  â”‚  â”‚              â”‚  â”‚              â”‚            â”‚
â”‚  â”‚   Text       â”‚  â”‚ Count: Real  â”‚  â”‚              â”‚            â”‚
â”‚  â”‚              â”‚  â”‚ via API âœ…   â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ Count: Real  â”‚  â”‚              â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ via API âœ…   â”‚  â”‚              â”‚  â”‚              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flow Examples

### Example 1: Fetching Notifications

```
User opens app
    â”‚
    â–¼
TopNavbar component mounts
    â”‚
    â–¼
useEffect triggers fetchNotifications()
    â”‚
    â–¼
GET /api/notifications
    â”‚
    â”œâ”€ Verify JWT token
    â”‚
    â”œâ”€ Extract userId from token
    â”‚
    â”œâ”€ Query: Notification.find({ user: userId })
    â”‚
    â”œâ”€ Calculate unreadCount
    â”‚
    â–¼
Return { data: [...], unreadCount: N }
    â”‚
    â–¼
TopNavbar updates state
    â”‚
    â–¼
Badge shows real count âœ…
```

### Example 2: Viewing a Note

```
User clicks "View Note"
    â”‚
    â–¼
Navigate to /notes/[id]
    â”‚
    â–¼
Page component mounts
    â”‚
    â–¼
GET /api/notes/[id]
    â”‚
    â”œâ”€ Verify JWT token
    â”‚
    â”œâ”€ Validate ObjectId âœ… (NEW)
    â”‚   â”‚
    â”‚   â”œâ”€ Invalid? â†’ Return 400
    â”‚   â”‚
    â”‚   â””â”€ Valid? â†’ Continue
    â”‚
    â”œâ”€ Query: Note.findById(id)
    â”‚   â”‚
    â”‚   â”œâ”€ Not found? â†’ Return 404
    â”‚   â”‚
    â”‚   â””â”€ Found? â†’ Continue
    â”‚
    â”œâ”€ Check workspace access
    â”‚   â”‚
    â”‚   â”œâ”€ No access? â†’ Return 403
    â”‚   â”‚
    â”‚   â””â”€ Has access? â†’ Continue
    â”‚
    â–¼
Return note data
    â”‚
    â–¼
Page displays note âœ…
```

### Example 3: Uploading a Document

```
User selects file and clicks upload
    â”‚
    â–¼
POST /api/documents (multipart/form-data)
    â”‚
    â”œâ”€ Verify JWT token
    â”‚
    â”œâ”€ Parse form data
    â”‚
    â”œâ”€ Validate file and title
    â”‚
    â”œâ”€ Check/create uploads folder âœ…
    â”‚   â”‚
    â”‚   â””â”€ fs.mkdirSync('public/uploads', { recursive: true })
    â”‚
    â”œâ”€ Save file to disk
    â”‚   â”‚
    â”‚   â””â”€ Generate unique filename
    â”‚
    â”œâ”€ Extract text from file
    â”‚   â”‚
    â”‚   â””â”€ documentProcessor.extractText()
    â”‚
    â”œâ”€ Save to MongoDB
    â”‚   â”‚
    â”‚   â””â”€ DocumentModel.create({...})
    â”‚
    â”œâ”€ Index for search
    â”‚   â”‚
    â”‚   â””â”€ searchService.indexDocument()
    â”‚
    â–¼
Return document data
    â”‚
    â–¼
Redirect to /documents/[id] âœ…
```

---

## ğŸ” Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTHENTICATION FLOW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User Login
   â”‚
   â”œâ”€ POST /api/auth/login
   â”‚  â”‚
   â”‚  â”œâ”€ Validate email format
   â”‚  â”œâ”€ Find user in MongoDB
   â”‚  â”œâ”€ Compare password (bcrypt)
   â”‚  â”œâ”€ Generate JWT token
   â”‚  â””â”€ Return token + user data
   â”‚
   â–¼
2. Store in localStorage
   â”‚
   â”œâ”€ localStorage.setItem('token', token)
   â””â”€ localStorage.setItem('user', JSON.stringify(user))
   â”‚
   â–¼
3. Subsequent Requests
   â”‚
   â”œâ”€ Add header: Authorization: Bearer <token>
   â”‚
   â”œâ”€ API verifies token
   â”‚  â”‚
   â”‚  â”œâ”€ jwt.verify(token, JWT_SECRET)
   â”‚  â”œâ”€ Extract userId
   â”‚  â””â”€ Use userId for queries
   â”‚
   â–¼
4. Access Control
   â”‚
   â”œâ”€ Check workspace membership
   â”œâ”€ Check resource ownership
   â””â”€ Return 403 if denied
```

---

## ğŸ“Š Data Consistency Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HOW COUNTS STAY ACCURATE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User creates a note
   â”‚
   â”œâ”€ POST /api/notes
   â”‚  â”‚
   â”‚  â””â”€ Note.create({...})
   â”‚
   â–¼
2. Frontend refreshes (2 options)
   â”‚
   â”œâ”€ Option A: Auto-refresh (30 seconds)
   â”‚  â”‚
   â”‚  â””â”€ useEffect interval calls fetchCounts()
   â”‚
   â””â”€ Option B: Manual refresh
      â”‚
      â””â”€ Call fetchCounts() after successful POST
   â”‚
   â–¼
3. GET /api/stats
   â”‚
   â”œâ”€ Note.countDocuments({ author: userId })
   â”‚
   â””â”€ Returns updated count âœ…
   â”‚
   â–¼
4. Sidebar updates
   â”‚
   â””â”€ Shows new count
```

---

## ğŸ¯ Key Improvements

### Before Fixes
```
âŒ Hardcoded notification count
âŒ Hardcoded sidebar counts
âŒ No ObjectId validation
âŒ No document viewer
âŒ Poor error messages
âŒ No logging utility
âŒ No env validation
```

### After Fixes
```
âœ… Real MongoDB queries everywhere
âœ… Auto-refresh for real-time feel
âœ… ObjectId validation on all [id] routes
âœ… Full document viewer with download
âœ… Clear, specific error messages
âœ… Centralized logger utility
âœ… Environment validation on startup
âœ… Production-ready architecture
```

---

## ğŸš€ Performance Optimizations

1. **countDocuments()** instead of `find().length`
   - Faster, doesn't load documents into memory
   
2. **Lean queries** for read-only data
   - Returns plain objects, not Mongoose documents
   
3. **Parallel queries** with `Promise.all()`
   - Fetches multiple counts simultaneously
   
4. **Indexed fields** in MongoDB
   - Fast lookups on user, workspace, author fields
   
5. **Connection pooling** in mongodb.ts
   - Reuses connections, doesn't create new ones

---

## ğŸ“ Error Handling Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ERROR HANDLING FLOW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

API Request
    â”‚
    â”œâ”€ Try-Catch Block
    â”‚  â”‚
    â”‚  â”œâ”€ Validate input
    â”‚  â”‚  â””â”€ Invalid? â†’ 400 Bad Request
    â”‚  â”‚
    â”‚  â”œâ”€ Verify authentication
    â”‚  â”‚  â””â”€ No token? â†’ 401 Unauthorized
    â”‚  â”‚
    â”‚  â”œâ”€ Check authorization
    â”‚  â”‚  â””â”€ No access? â†’ 403 Forbidden
    â”‚  â”‚
    â”‚  â”œâ”€ Query database
    â”‚  â”‚  â””â”€ Not found? â†’ 404 Not Found
    â”‚  â”‚
    â”‚  â””â”€ Process & return
    â”‚     â””â”€ Success? â†’ 200 OK
    â”‚
    â””â”€ Catch Errors
       â”‚
       â”œâ”€ JsonWebTokenError â†’ 401
       â”œâ”€ ValidationError â†’ 400
       â”œâ”€ MongoError â†’ 503
       â””â”€ Unknown â†’ 500
```

---

This architecture is now **production-ready** with:
- âœ… Real data from MongoDB
- âœ… Proper error handling
- âœ… Security best practices
- âœ… Performance optimizations
- âœ… Clean code organization
